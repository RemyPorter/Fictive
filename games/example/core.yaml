main_machine:
    entry_commands: &entry_cmd
        matcher: (go|leave|next|get out|move on)
    middle_commands: &mid_cmd
        matcher: (go back|back|return|entry)
    mysterious: &set_title_mysterious
        banner: The Mysterious Room
    archway: &set_title_archway
        banner: The Archway
    main_states: &main_states
        - state:
            tag: entry
            description: >
                You are in a mysterious room.
                It's hard to say what's so mysterious about it.
                That is what's so mysterious.
            sub_machine: *switched
            on_enter: 
                *set_title_mysterious
        - state:
            tag: middle_off
            description: >
                In this room, there is a large archway. You can easily walk through it, but nothing happens.
                Large cables run to the archway. It seems to need power.
            on_enter: 
                *set_title_archway
        - state:
            tag: middle_on
            description: |
                The cables hum with the power *coursing* through them. The archway crackles, 
                its energy forming a hazy portal within it.

                This state contains an error in its description, as it attempts to print out an undefined
                statebag key: {no_key}
            on_enter: 
                *set_title_archway
        - state:
            tag: exit
            description: |
                You have stepped through the archway. Every atom in your body is disassembled
                and reassembled. You are dead. You live on. Are you the same person? You do not know.
                You have exited the maze.

                # The End

                Press enter to exit
            on_enter:
                banner: The End of the Story
        - state:
            tag: help
            description: >
                This is a simple text adventure. Try commands like `go`, `back`, `switch`, `check power`,
                and see what happens.
            on_enter: revert
    machine: &main
        startTag: entry
        endTag: exit
        states:
            - *power_states
            - *main_states
        transitions:
            - transition:
                from: entry
                to: middle_off
                condition:
                    - on_match: *entry_cmd
                    - on_key:
                        key: switch
                        value: off
            - transition:
                from: middle_off
                to: entry
                condition:
                    on_match: *mid_cmd
            - transition:
                from: entry
                to: middle_on
                condition:
                    - on_match: *entry_cmd
                    - on_key:
                        key: switch
                        value: on
            - transition:
                from: middle_on
                to: entry
                condition:
                    on_match: *mid_cmd
            - transition:
                from: middle_on
                to: exit
                condition:
                    - on_match: *entry_cmd
        global_transitions:
            - *power_trans
            - transition:
                to: help
                condition:
                    on_match: 
                        matcher: (help|\?)